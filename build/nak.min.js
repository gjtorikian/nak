function merge(e,r){for(var o=[];e.length>0&&r.length>0;)e[0].toLowerCase()>r[0].toLowerCase()?o.push(r.shift()):o.push(e.shift());return o=o.concat(e,r)}function help(){console.error("Usage: [options] 'PATTERN' ['REPLACEMENT'] 'PATH' \n"),console.error("Options:");for(var e=0,r=schema[0];schema.length>e;e++,r=schema[e]){var o=(r[0]?"-"+r[0]+(r[1]?"|":""):"   ")+(r[1]?"--"+r[1]:""),i=o+(-1!=r[2].indexOf(":")?" Â«valueÂ»":"");i+=20>i.length?Array(20-i.length).join(" "):"",console.error("	"+(-1!=r[2].indexOf("!")?"*":" ")+(-1!=r[2].indexOf("+")?"+":" ")+i+"	"+r[3])}process.exit(0)}function setExclusions(e){var r=dirExclusions=[];options.pathToNakignore&&(r=fs.readFileSync(options.pathToNakignore,"utf-8"));try{dirExclusions=fs.readFileSync(e+"/.nakignore","utf-8")}catch(o){}var i=r+"\n"+dirExclusions+"\n"+(void 0!==options.ignore?options.ignore:"");i.length&&(options.exclusions=i.split(/\r?\n/).filter(function(e){return!!e&&/^[^#]/.test(e)}),options.exclusionsLength=options.exclusions.length)}function makeQuery(e,r){var o="g";options.literal&&(e=ignorer.escapeRegExp(e)),options.ignoreCase&&(o+="i"),options.wordRegexp&&(e="\\b(?:"+e+")\\b"),options.query=RegExp(e,o),r&&(options.replacement=r)}var fs=require("fs");isbinaryfile=function(e,r){if(void 0===r){var o=e;e=fs.readFileSync(o),r=fs.statSync(o).size}var i=0,t=r>1024?1024:r;if(0==r)return!1;if(r>=3&&239==e[0]&&187==e[1]&&191==e[2])return 0;for(var n=0;t>n;n++){if(n>32&&100*i/t>10)return!0;if("0"==e[n])return!0;if((7>e[n]||e[n]>14)&&(32>e[n]||e[n]>127)){if(e[n]>191&&224>e[n]&&t>n+1){if(n++,192>e[n])continue}else if(e[n]>223&&239>e[n]&&t>n+2&&(n++,192>e[n]&&192>e[n+1])){n++;continue}i++}}return 100*i/t>10?!0:!1};var mergesort=module.exports=function(e){var r=e.length;if(2>r)return e;var o=Math.ceil(r/2);return merge(mergesort(e.slice(0,o)),mergesort(e.slice(o)))},ignorer={};module.exports=ignorer;var makeRules=ignorer.makeRules=function(e,r){for(var o=[],i=0,t=function(e){return RegExp(escapeRegExp(e).replace(/\\\*/g,".?"))};r>i;)o.push(t(e[i++]));return o},isIgnored=ignorer.isIgnored=function(e,r,o,i){if(!i&&(/^\.\w/.test(o)||/\/\.\w/.test(o)))return!0;for(var t=0;r>t;)if(e[t++].test(o))return!0;return!1},escapeRegExp=ignorer.escapeRegExp=function(e){return e.replace(/([\/'*+?|()\[\]{}.^$])/g,"\\$1")},makeWildcardRegExp=ignorer.makeWildcardRegExp=function(e,r){return e?(e=e.replace(/\s/g,""),e=escapeRegExp(e),e=e.replace(/\\\*/g,".*"),e=e.replace(/\\\?/g,"."),r?(e=e.replace(/,/g,"|"),e=RegExp("(?:"+e+")")):e):""},parser={};module.exports=parser;var schema=[["l","list","","list files encountered"],["H","hidden","","search hidden files and directories (default off)"],["c","color","","adds color to results  (default off)"],["a","pathToNakignore",":","path to an additional nakignore file"],["m","maxdepth",":","the maximum depth of the search"],["q","literal","","do not parse PATTERN as a regular expression; match it literally"],["w","wordRegexp","","only match whole words"],["i","ignoreCase","","match case insensitively"],["G","fileSearch",":","comma-separated list of wildcard files to only search on"],["d","ignore",":","comma-separated list of wildcard files to additionally ignore"],["p","piped","","indicates filenames are being piped in (like, from ag or find)"]],parseArgs=parser.parseArgs=function(e){2!=process.argv.length||e?void 0!==e&&(process.argv=e):help();var r=[],o={};o.args=[];for(var i=0,t=process.argv[0],n=process.argv.length;n>i;i++,t=process.argv[i])"-"==t.charAt(0)?"-"==t.charAt(1)?r.push("--",t.slice(2)):r=r.concat(t.split("").join("-").split("").slice(1)):r.push(t);for(;type=r.shift();)if("-"==type||"--"==type){var s=r.shift();("help"==s||"h"==s)&&help();for(var a=null,i=0,t=schema[0];schema.length>i;i++,t=schema[i])if(t[type.length-1]==s){a=t;break}var l=!0;-1==a[2].indexOf(":")||(l=r.shift())||(console.error("Option '"+type+s+"' expects a parameter!"),help());var c=a[1]||a[0];-1!=a[2].indexOf("+")?(o[c]=o[c]instanceof Array?o[c]:[],o[c].push(l)):o[c]=l,"function"==typeof a[4]&&a[4](l),a[2]=a[2].replace("!","")}else o.args.push(type);return void 0===e&&o.args.splice(0,2),o},walker={};module.exports=walker;var fs=require("fs"),_path=require("path"),StringDecoder=require("string_decoder").StringDecoder,decoder=new StringDecoder("utf8"),ignorer=ignorer,isBinaryFile=isbinaryfile,mergesort=mergesort,allPaths={},allFiles={},ended=0,jobs=0,DIR_SEP="/",job=function(e){jobs+=e,1>e&&!tick&&(tick=1,process.nextTick(function(){tick=0,0>=jobs&&!ended&&(ended=1,finalizer())}))},tick=0;walker.walkdir=function(e,r,o,i){if(r.maxdepth=r.maxdepth||1/0,r.exclusions=r.exclusionsLength>0?ignorer.makeRules(r.exclusions,r.exclusionsLength):"",r.hidden=r.hidden||!1,finalizer=function(){if(r.list){for(var e=mergesort(Object.keys(allPaths)),t="",n="",s=0,a=e.length;a>s;s++)n=allPaths[e[s]],t+=mergesort(n).join("\n")+"\n";o(t)}else{for(var l=mergesort(Object.keys(allFiles)),c=0,p=l.length;p>c;c++){var f=l[c],u=fs.readFileSync(f);if(!isBinaryFile(u,allFiles[f].stat.size)){var g=decoder.write(u);if(r.query.lastIndex=0,r.query.test(g)){var d=g.match(r.query).length,h=d,m="";if(r.replacement){var x=g.replace(r.query,r.replacement);fs.writeFile(f,x,"utf8")}for(var g=g.split("\n"),v=0,y=g.length;h&&y>v;v++)r.query.lastIndex=0,r.query.test(g[v])&&(m+="	"+(v+1)+": "+(r.replacement?g[v].replace(r.query,r.replacement):g[v])+"\n",h--);o(f,m,d,l)}}}i()}},statter=function(e,o,i){job(1);var t=function(t){job(-1),t.isFile()?r.list?allPaths[e].push(o):(allFiles[o]={},allFiles[o].stat=t):t.isDirectory()&&readdir(o,i)};t(fs.lstatSync(o))},readdir=function(e,o){if(!(o>=r.maxdepth)){var i=function(i){if(job(-1),!i)return"Permission error (or other failure) on: "+i;var t=i.length,n=0;for(allPaths[e]=[];t>n;){var s=i[n++],a=e+DIR_SEP+s;r.filesInclude.test(s)&&!ignorer.isIgnored(r.exclusions,r.exclusionsLength,a,r.hidden)&&statter(e,a,(o||0)+1)}};ignorer.isIgnored(r.exclusions,r.exclusionsLength,e,r.hidden)||(job(1),fs.readdir(e,function(e,r){e&&(console.error(e),process.exit(1)),i(r)}))}},r.piped)for(var t=e.split("\n"),n=0,s=t.length;s>n;n++)t[n].length&&statter(t[n]);else readdir(e,1)};var options=parser.parseArgs(),fs=require("fs"),path=require("path"),walkdir=walker.walkdir,ignorer=ignorer;if(options.piped)process.stdin.resume(),process.stdin.setEncoding("utf8"),options.args.length>1?makeQuery(options.args.shift(),options.args.shift()):makeQuery(options.args.shift()),process.stdin.on("data",function(e){options.piped=!0,walkdir(e,options,function(e,r){options.color?(console.log(fileColor,e),r=r.replace(query,textColor),console.log(matchColor,r)):(console.log(e),console.log(r))})});else{var fpath=path.resolve(options.args.pop()),replacement=null,query=null,fileColor="",textColor="",matchColor="";if(1==options.args.length?query=options.args.pop():2==options.args.length&&(replacement=options.args.pop(),query=options.args.pop()),options.color&&(fileColor="\n[36m%s[0m",textColor="[37;43m[0;90m",matchColor="[90m%s"),options.filesInclude=options.fileSearch?ignorer.makeWildcardRegExp(options.fileSearch,!0):{test:function(){return!0}},setExclusions(fpath),query){makeQuery(query,replacement);var matches=0,filecount=0;walkdir(fpath,options,function(e,r,o){options.color?(console.log(fileColor,e+":"),r=r.replace(options.query,textColor),console.log(matchColor,r)):(console.log(e+":"),console.log(r)),matches+=o,filecount++},function(){console.log("Found "+matches+(1==matches?" match":" matches")+" in "+filecount+(1==filecount?" file ":" files "))})}else options.list&&walkdir(fpath,options,function(e){console.log(e)})}